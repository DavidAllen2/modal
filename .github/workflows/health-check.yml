name: ğŸ©º ç›‘æ§æ‰€æœ‰é¡¹ç›® (Monitor All Projects)

on:
  schedule:
    # æ¯ 1 å°æ—¶æ£€æµ‹ä¸€æ¬¡
    - cron: '0 */1 * * *'
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.ACTION_TRIGGER_TOKEN }}

  # --- ä»“åº“ 1 (ä¸»ä»“åº“) ---
  REPO_PROJECT_1: 'Githubå/modalé¡¹ç›®å' # <-- æ›¿æ¢ 'Githubé¡¹ç›®å®Œæ•´å'
  URL_PROJECT_1: 'https://tunnel-url-for-fs-modal.com' # <-- ä½ çš„éš§é“ URL
  DEPLOY_FILE_1: 'main.yml' # ä»“åº“1çš„éƒ¨ç½²æ–‡ä»¶å
  
  # --- ä»“åº“ 2 ---
  REPO_PROJECT_2: 'Githubå/modalé¡¹ç›®å' # <-- æ›¿æ¢ 'Githubé¡¹ç›®å®Œæ•´å'
  URL_PROJECT_2: 'https://tunnel-url-for-modal-SG.com' # <-- ä½ çš„éš§é“ URL
  DEPLOY_FILE_2: 'main.yml' # ä»“åº“2çš„éƒ¨ç½²æ–‡ä»¶å
  
  # --- ä»“åº“ 3 ---
  REPO_PROJECT_3: 'Githubå/modalé¡¹ç›®å' # <-- æ›¿æ¢ 'Githubé¡¹ç›®å®Œæ•´å'
  URL_PROJECT_3: 'https://tunnel-url-for-modal-jp-aws.com' # <-- ä½ çš„éš§é“ URL
  DEPLOY_FILE_3: 'main.yml' # ä»“åº“3çš„éƒ¨ç½²æ–‡ä»¶å

jobs:
  check-all-projects:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€æŸ¥é¡¹ç›® 1 (Check Project 1)
        id: check_1
        run: |
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 $URL_PROJECT_1)
          echo "Project 1 Status: $HTTP_STATUS"
          echo "http_status=$HTTP_STATUS" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥é¡¹ç›® 2 (Check Project 2)
        id: check_2
        run: |
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 $URL_PROJECT_2)
          echo "Project 2 Status: $HTTP_STATUS"
          echo "http_status=$HTTP_STATUS" >> $GITHUB_OUTPUT
          
      - name: æ£€æŸ¥é¡¹ç›® 3 (Check Project 3)
        id: check_3
        run: |
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 $URL_PROJECT_3)
          echo "Project 3 Status: $HTTP_STATUS"
          echo "http_status=$HTTP_STATUS" >> $GITHUB_OUTPUT

      # --- è§¦å‘å™¨éƒ¨åˆ† ---

      - name: ğŸ”´ è§¦å‘å™¨ (Project 1)
        if: "!startsWith(steps.check_1.outputs.http_status, '2') && steps.check_1.outputs.http_status != '400'"
        run: |
          echo "Project 1 éš§é“ä¸é€š (Status: ${{ steps.check_1.outputs.http_status }}), æ­£åœ¨è§¦å‘..."
          curl --fail -X POST -H "Accept: application/vnd.github.v3+json" -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/repos/$REPO_PROJECT_1/actions/workflows/$DEPLOY_FILE_1/dispatches" -d '{"ref":"main"}'

      - name: ğŸ”´ è§¦å‘å™¨ (Project 2)
        if: "!startsWith(steps.check_2.outputs.http_status, '2') && steps.check_2.outputs.http_status != '400'"
        run: |
          echo "Project 2 éš§é“ä¸é€š (Status: ${{ steps.check_2.outputs.http_status }}), æ­£åœ¨è§¦å‘..."
          curl --fail -X POST -H "Accept: application/vnd.github.v3+json" -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/repos/$REPO_PROJECT_2/actions/workflows/$DEPLOY_FILE_2/dispatches" -d '{"ref":"main"}'
          
      - name: ğŸ”´ è§¦å‘å™¨ (Project 3)
        if: "!startsWith(steps.check_3.outputs.http_status, '2') && steps.check_3.outputs.http_status != '400'"
        run: |
          echo "Project 3 éš§é“ä¸é€š (Status: ${{ steps.check_3.outputs.http_status }}), æ­£åœ¨è§¦å‘..."
          curl --fail -X POST -H "Accept: application/vnd.github.v3+json" -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/repos/$REPO_PROJECT_3/actions/workflows/$DEPLOY_FILE_3/dispatches" -d '{"ref":"main"}'